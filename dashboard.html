<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>25 대시보드</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 15px 0;
        }
        header h1 {
            font-size: 1.5em;
            margin: 0;
        }
        #dashboard {
            padding: 10px;
        }
        table {
            width: 100%;
            margin-bottom: 20px;
            background: white;
            border-collapse: collapse;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table caption {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 0;
            background-color: #f5f5f5;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f0f0f0;
        }
        input[type="text"] {
            width: 80%;
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="welcome-message"></h1>
    </header>
    <div id="dashboard">
        <!-- 군별 점수 및 실기 테이블 -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const name = localStorage.getItem('studentName');
            if (!name) {
                alert('로그인이 필요합니다.');
                window.location.href = '/index.html';
                return;
            }

            document.getElementById('welcome-message').textContent = `${name} 환영합니다!`;

            try {
                const response = await fetch('https://supermax.kr/25getStudentScores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    const gender = result.gender;
                    localStorage.setItem('studentGender', gender); // 성별 저장
                    const dashboardDiv = document.getElementById('dashboard');

                    data.forEach(row => {
                        // 점수 테이블
                        const scoreTable = document.createElement('table');
                        scoreTable.border = 1;

                        const scoreCaption = document.createElement('caption');
                        scoreCaption.textContent = `${row.군} (${row.대학명} - ${row.학과명})`;
                        scoreTable.appendChild(scoreCaption);

                        const scoreTbody = document.createElement('tbody');
                        scoreTbody.innerHTML = `
                            <tr>
                                <th>수능점수</th>
                                <th>내신점수</th>
                                <th>실기점수</th>
                                <th>총점</th>
                            </tr>
                            <tr>
                                <td>${row.수능점수 || ''}</td>
                                <td>${row.내신점수 || ''}</td>
                                <td id="${row.군}-실기점수"></td>
                                <td id="${row.군}-총점"></td>
                            </tr>
                        `;
                        scoreTable.appendChild(scoreTbody);
                        dashboardDiv.appendChild(scoreTable);

                        // 실기 종목 테이블
                        const eventTable = document.createElement('table');
                        eventTable.border = 1;

                        const eventTbody = document.createElement('tbody');
                        const eventRow = document.createElement('tr');

                        for (let i = 1; i <= 6; i++) {
                            const 종목이름 = row[`실기종목${i}`];
                            if (종목이름) {
                                const cell = document.createElement('td');
                                cell.innerHTML = `
                                    <strong>${종목이름}</strong><br>
                                    <input 
                                        type="text" 
                                        placeholder="기록 입력" 
                                        id="${row.군}-종목${i}-기록" 
                                        data-군="${row.군}" 
                                        data-종목="${i}"
                                        data-university="${row.대학명}"
                                        data-major="${row.학과명}"
                                        oninput="calculateScore(this)"
                                    >
                                    <br>
                                    점수: <span id="${row.군}-종목${i}-점수"></span>
                                `;
                                eventRow.appendChild(cell);
                            }
                        }

                        eventTbody.appendChild(eventRow);
                        eventTable.appendChild(eventTbody);
                        dashboardDiv.appendChild(eventTable);
                    });
                } else {
                    alert(result.message || '점수를 불러오는 데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error fetching student scores:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        });

        async function calculateScore(input) {
            const 군 = input.dataset.군;
            const 종목 = input.dataset.종목;
            const university = input.dataset.university;
            const major = input.dataset.major;
            const 기록 = parseFloat(input.value);
            const gender = localStorage.getItem('studentGender'); // 저장된 성별 가져오기

            if (!gender) {
                alert('성별 정보가 없습니다. 다시 로그인해주세요.');
                return;
            }

            if (isNaN(기록)) {
                document.getElementById(`${군}-종목${종목}-점수`).textContent = '';
                updateTotalScore(군);
                return;
            }

            try {
                const response = await fetch('https://supermax.kr/25calculatePracticalScores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        universityName: university,
                        majorName: major,
                        gender, // 성별 추가
                        records: [기록]
                    })
                });

                const result = await response.json();

                if (result.success && result.scores.length > 0) {
                    const 점수 = result.scores[0];
                    document.getElementById(`${군}-종목${종목}-점수`).textContent = 점수;

                    // 실기점수 및 총점 업데이트
                    updateTotalScore(군);
                } else {
                    throw new Error(result.message || '점수 계산 실패');
                }
            } catch (error) {
                console.error('점수 계산 오류:', error);
                alert('점수 계산 중 오류가 발생했습니다.');
            }
        }

        function updateTotalScore(군) {
            const 실기점수칸들 = document.querySelectorAll(`[id^="${군}-종목"][id$="-점수"]`);
            let 실기점수 = 0;

            실기점수칸들.forEach(cell => {
                const value = parseFloat(cell.textContent);
                if (!isNaN(value)) 실기점수 += value;
            });

            const 실기점수칸 = document.getElementById(`${군}-실기점수`);
            실기점수칸.textContent = 실기점수.toFixed(2);

            // 총점 계산 (수능점수 + 내신점수 + 실기점수)
            const 수능점수 = parseFloat(document.querySelector(`#${군}-수능점수`).textContent) || 0;
            const 내신점수 = parseFloat(document.querySelector(`#${군}-내신점수`).textContent) || 0;

            const 총점칸 = document.getElementById(`${군}-총점`);
            총점칸.textContent = (수능점수 + 내신점수 + 실기점수).toFixed(2);
        }
    </script>
</body>
</html>
